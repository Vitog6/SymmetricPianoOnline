<!DOCTYPE html><html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suoni con la tastiera (Scala su due ottave)</title>
</head>
<body>
    <h1>Premi un tasto per ascoltare la nota</h1>
    <p>Premi uno dei seguenti tasti:</p>
    <ul>
        <li>Prima ottava: Tab, Q, W, E, R, T, 1, 2, 3, 4, 5, 6</li>
        <li>Seconda ottava: Y, U, I, O, P, [, 7, 8, 9, 0, ', ì</li>
    </ul><script>
    const frequenze = {
        "Tab": 261.63,  "Q": 293.66,  "W": 329.63,  "E": 370.00,  "R": 415.30,  "T": 466.16,
        "1": 277.18,  "2": 311.13,  "3": 349.23,  "4": 392.00,  "5": 440.00,  "6": 493.88,
        "Y": 523.25, "U": 587.33, "I": 659.26, "O": 739.99, "P": 830.61, "[": 932.33,
        "7": 554.37, "8": 622.25, "9": 698.46, "0": 783.99, "'": 880.00, "ì": 987.77
    };

    let audioContext;
    const tastiAttivi = new Map();
    let masterGain;

    function inizializzaAudioContext() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            masterGain = audioContext.createGain();
            masterGain.gain.value = 1;
            masterGain.connect(audioContext.destination);
        }
    }

    function aggiornaVolumi() {
        let totalePesi = 0;
        for (const { gainNode, peso } of tastiAttivi.values()) totalePesi += peso;
        for (const nota of tastiAttivi.values()) {
            const proporzione = nota.peso / totalePesi;
            nota.gainNode.gain.setTargetAtTime(proporzione, audioContext.currentTime, 0.01);
        }
    }

    function suonaNota(tasto) {
        inizializzaAudioContext();
        const frequenza = frequenze[tasto];
        if (!frequenza) return;

        const oscillatore = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        gainNode.gain.value = 0;

        oscillatore.type = "sine";
        oscillatore.frequency.setValueAtTime(frequenza, audioContext.currentTime);
        oscillatore.connect(gainNode);
        gainNode.connect(masterGain);

        oscillatore.start();
        gainNode.gain.linearRampToValueAtTime(1, audioContext.currentTime + 0.01);

        tastiAttivi.set(tasto, { oscillatore, gainNode, peso: 1 });
        aggiornaVolumi();
    }

    function interrompiNota(tasto) {
        const nota = tastiAttivi.get(tasto);
        if (!nota) return;

        nota.peso = 0.001;
        nota.gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.3);
        nota.oscillatore.stop(audioContext.currentTime + 0.3);

        setTimeout(() => {
            tastiAttivi.delete(tasto);
            aggiornaVolumi();
        }, 310);

        aggiornaVolumi();
    }

    document.addEventListener("keydown", (e) => {
        if (e.repeat) return;
        if (frequenze[e.key] && !tastiAttivi.has(e.key)) {
            if (e.key === "Tab") e.preventDefault();
            suonaNota(e.key);
        }
    });

    document.addEventListener("keyup", (e) => {
        if (frequenze[e.key]) interrompiNota(e.key);
    });

    document.body.addEventListener("click", inizializzaAudioContext);
</script>

</body>
</html>
