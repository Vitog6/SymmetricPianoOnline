<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suoni con la tastiera (Scala su due ottave)</title>
</head>
<body>
  <h1>Premi un tasto per ascoltare la nota</h1>
  <p>Premi uno dei seguenti tasti:</p>
  <ul>
    <li>Prima ottava: Tab, Q, W, E, R, T, 1, 2, 3, 4, 5, 6</li>
    <li>Seconda ottava: Y, U, I, O, P, [, 7, 8, 9, 0, ', ì</li>
  </ul>

  <script>
    const frequenze = {
      "Tab": 261.63, "Q": 293.66, "W": 329.63, "E": 370.00, "R": 415.30, "T": 466.16,
      "1": 277.18, "2": 311.13, "3": 349.23, "4": 392.00, "5": 440.00, "6": 493.88,
      "Y": 261.63 * 2, "U": 293.66 * 2, "I": 329.63 * 2, "O": 370.00 * 2, "P": 415.30 * 2, "[": 466.16 * 2,
      "7": 277.18 * 2, "8": 311.13 * 2, "9": 349.23 * 2, "0": 392.00 * 2, "'": 440.00 * 2, "ì": 493.88 * 2
    };

    let audioContext;
    const tastiPremuti = {};
    let masterGain;

    function inizializzaAudioContext() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = audioContext.createGain();
        masterGain.gain.value = 1;
        masterGain.connect(audioContext.destination);
        requestAnimationFrame(aggiornaBilanciamento);
      }
    }

    function aggiornaBilanciamento() {
      let somma = 0;
      for (const tasto in tastiPremuti) {
        try {
          somma += tastiPremuti[tasto].gainNode.gain.value;
        } catch {}
      }
      const nuovoVolume = somma > 0 ? 1 / somma : 1;
      masterGain.gain.setValueAtTime(nuovoVolume, audioContext.currentTime);
      requestAnimationFrame(aggiornaBilanciamento);
    }

    function suonaNota(tasto) {
      if (!frequenze[tasto] || tastiPremuti[tasto]) return;
      inizializzaAudioContext();

      const osc = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      const now = audioContext.currentTime;

      osc.type = 'sine';
      osc.frequency.setValueAtTime(frequenze[tasto], now);

      // Volume dinamico in base alla frequenza (più alto = volume minore)
      let volumeBase = 5000 / frequenze[tasto];
      volumeBase = Math.min(1, Math.max(0.05, volumeBase));

      gainNode.gain.setValueAtTime(volumeBase, now);
      osc.connect(gainNode).connect(masterGain);
      osc.start();

      tastiPremuti[tasto] = { osc, gainNode };
    }

    function interrompiNota(tasto) {
      const nota = tastiPremuti[tasto];
      if (!nota) return;

      const now = audioContext.currentTime;

      // Fade-out morbido con curva esponenziale per evitare scricchiolii
      nota.gainNode.gain.cancelScheduledValues(now);
      nota.gainNode.gain.setTargetAtTime(0.0001, now, 0.05);
      nota.osc.stop(now + 0.3); // Lascia tempo al fade-out di concludersi

      delete tastiPremuti[tasto];
    }

    document.addEventListener("keydown", function(event) {
      const tasto = event.key;
      if (frequenze[tasto] && !tastiPremuti[tasto]) {
        if (tasto === "Tab") event.preventDefault();
        suonaNota(tasto);
      }
    });

    document.addEventListener("keyup", function(event) {
      const tasto = event.key;
      interrompiNota(tasto);
    });

    document.body.addEventListener("click", inizializzaAudioContext);
  </script>
</body>
</html>
