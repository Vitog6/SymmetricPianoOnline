<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suoni con la tastiera (Scala su due ottave)</title>
</head>
<body>
    <h1>Premi un tasto per ascoltare la nota</h1>
    <p>Premi uno dei seguenti tasti:</p>
    <ul>
        <li>Prima ottava: Tab, Q, W, E, R, T, 1, 2, 3, 4, 5, 6</li>
        <li>Seconda ottava: Y, U, I, O, P, [, 7, 8, 9, 0, ', ì</li>
    </ul>

    <script>
        // Frequenze delle note (due ottave, doppio della frequenza nella seconda ottava)
        const frequenze = {
            "Tab": 261.63,  "Q": 293.66,  "W": 329.63,  "E": 370.00,  "R": 415.30,  "T": 466.16,
            "1": 277.18,  "2": 311.13,  "3": 349.23,  "4": 392.00,  "5": 440.00,  "6": 493.88,
            "Y": 261.63 * 2, "U": 293.66 * 2, "I": 329.63 * 2, "O": 370.00 * 2, "P": 415.30 * 2, "[": 466.16 * 2,
            "7": 277.18 * 2, "8": 311.13 * 2, "9": 349.23 * 2, "0": 392.00 * 2, "'": 440.00 * 2, "ì": 493.88 * 2
        };

        let audioContext;
        const tastiPremuti = {}; // Mappa per tenere traccia degli oscillatori attivi
        let masterGain;

        function inizializzaAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                masterGain = audioContext.createGain();
                masterGain.gain.value = 1;
                masterGain.connect(audioContext.destination);
            }
        }

        function aggiornaVolumeMaster() {
            // Calcola quante note stanno suonando
            const nTasti = Object.keys(tastiPremuti).length;
            if (nTasti > 0) {
                masterGain.gain.setTargetAtTime(1 / nTasti, audioContext.currentTime, 0.01); // Volume master ridotto
            } else {
                masterGain.gain.setTargetAtTime(1, audioContext.currentTime, 0.01); // Volume normale
            }
        }

        function suonaNota(frequenza) {
            inizializzaAudioContext();

            const oscillatore = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            const lowPassFilter = audioContext.createBiquadFilter();

            oscillatore.type = "sine";
            oscillatore.frequency.setValueAtTime(frequenze[frequenza], audioContext.currentTime);

            // Volume dinamico in base alla frequenza
            let volumeBase = 5000 / frequenze[frequenza];
            if (volumeBase > 1) volumeBase = 1;
            if (volumeBase < 0.05) volumeBase = 0.05;

            gainNode.gain.setValueAtTime(0, audioContext.currentTime);  // Inizia con volume 0 (infusione)
            gainNode.gain.linearRampToValueAtTime(volumeBase, audioContext.currentTime + 0.05); // Graduale aumento

            // Filtro passa-basso per ridurre le alte frequenze durante il fade-out
            lowPassFilter.type = "lowpass";
            lowPassFilter.frequency.setValueAtTime(3000, audioContext.currentTime);

            oscillatore.connect(lowPassFilter);
            lowPassFilter.connect(gainNode);
            gainNode.connect(masterGain);

            oscillatore.start();

            // Memorizza l'oscillatore e il gainNode per il tasto premuto
            tastiPremuti[frequenza] = { oscillatore, gainNode, lowPassFilter };

            aggiornaVolumeMaster(); // Regola il volume master
        }

        function interrompiNota(frequenza) {
            const nota = tastiPremuti[frequenza];
            if (!nota) return; // Se la nota non è attiva, esci

            // Dissolvenza ultra-morbida e arresto dell'oscillatore
            const fadeOutDuration = 1; // durata di dissolvenza in secondi
            nota.gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + fadeOutDuration); // Rampa più lunga
            nota.oscillatore.stop(audioContext.currentTime + fadeOutDuration); // Fermiamo l'oscillatore dopo la dissolvenza
            delete tastiPremuti[frequenza];

            aggiornaVolumeMaster(); // Regola il volume master
        }

        document.addEventListener("keydown", function(event) {
            const tasto = event.key;
            if (frequenze[tasto] && !tastiPremuti[tasto]) {
                // Previeni lo spostamento di focus per il Tab
                if (tasto === "Tab") event.preventDefault();
                suonaNota(tasto);
            }
        });

        document.addEventListener("keyup", function(event) {
            const tasto = event.key;
            interrompiNota(tasto);  // Interrompi la nota e applica dissolvenza
        });

        document.body.addEventListener("click", inizializzaAudioContext); // Attiva AudioContext al primo click
    </script>
</body>
</html>
