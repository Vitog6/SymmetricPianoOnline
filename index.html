<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suoni con la tastiera</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #222;
      margin: 0;
    }
    .keyboard {
      position: relative;
      width: 672px;
      height: 200px;
      transform: rotate(180deg); /* Capovolgimento della tastiera */
    }
    .white-key, .black-key {
      position: absolute;
      bottom: 0;
      border: 1px solid #000;
      box-sizing: border-box;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      padding-bottom: 5px;
      font-size: 12px;
      font-weight: bold;
      pointer-events: none;
      transform: rotate(180deg);
    }
    .white-key {
      width: 56px;
      height: 200px;
      background: white;
      z-index: 1;
    }
    .black-key {
      width: 40px;
      height: 120px;
      background: black;
      color: white;
      z-index: 2;
    }
    .active {
      background-color: #4caf50 !important;
    }
    .key-label {
      position: absolute;
      bottom: 10px;
      font-size: 14px;
      font-weight: bold;
      color: #000;
    }
  </style>
</head>
<body>
  <div class="keyboard" id="keyboard"></div>
  <script>
    const noteLabels = [
      "Do", "Re", "Mi", "Fa", "Sol", "La", "Si", "Do'", "Re'", "Mi'", "Fa'", "Sol'"
    ];
    const blackNoteLabels = [
      "Do#", "Re#", "", "Fa#", "Sol#", "La#", "", "Do#'", "Re#'", "", "Fa#'", "Sol#'"
    ];

    const whiteKeys = [
      "Tab", "Q", "W", "E", "R", "T",
      "Y", "U", "I", "O", "P", "ì"
    ];

    const blackKeys = [
      "1", "2", "3", "4", "5", "6",
      "7", "8", "9", "0", "'", "["
    ];

    const frequenze = {
      "Tab": 261.63,  "Q": 293.66,  "W": 329.63,  "E": 370.00,  "R": 415.30,  "T": 466.16,
      "1": 277.18,  "2": 311.13,  "3": 349.23,  "4": 392.00,  "5": 440.00,  "6": 493.88,
      "Y": 523.25, "U": 587.33, "I": 659.26, "O": 740.00, "P": 830.61, "[": 932.33,
      "7": 554.37, "8": 622.25, "9": 698.46, "0": 784.00, "'": 880.00, "ì": 987.77
    };

    const noteAttive = {};

    function inizializzaAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();

        limiter = audioContext.createDynamicsCompressor();
        limiter.threshold.setValueAtTime(-1, audioContext.currentTime); // soglia
        limiter.knee.setValueAtTime(0, audioContext.currentTime);       // transizione netta
        limiter.ratio.setValueAtTime(20, audioContext.currentTime);     // compressione forte
        limiter.attack.setValueAtTime(0.001, audioContext.currentTime); // attacco rapido
        limiter.release.setValueAtTime(0.05, audioContext.currentTime); // rilascio rapido

        masterGain = audioContext.createGain();
        masterGain.gain.value = 1;

        masterGain.connect(limiter);
        limiter.connect(audioContext.destination);
      }
    }

    function aggiornaMasterGain() {
      const attive = Object.keys(noteAttive).length;
      const volumeTotale = attive > 0 ? 1 / attive : 1;
      masterGain.gain.setValueAtTime(volumeTotale, audioContext.currentTime);
    }

    function suonaNota(tasto) {
      if (!frequenze[tasto]) return;
      inizializzaAudio();

      if (noteAttive[tasto]) return;

      const nAttive = Object.keys(noteAttive).length;
      const nuovoVolume = 1 / (nAttive + 1);
      masterGain.gain.setValueAtTime(nuovoVolume, audioContext.currentTime);

      const osc = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      osc.frequency.setValueAtTime(frequenze[tasto], audioContext.currentTime);
      osc.type = 'sine';

      gainNode.gain.setValueAtTime(1, audioContext.currentTime);

      osc.connect(gainNode).connect(masterGain);
      osc.start();

      noteAttive[tasto] = { osc, gainNode };

      aggiornaMasterGain();
    }

    function interrompiNota(tasto) {
      const nota = noteAttive[tasto];
      if (!nota) return;

      const now = audioContext.currentTime;
      const durataFade = 0.5;

      nota.gainNode.gain.setValueAtTime(1, now);
      nota.gainNode.gain.linearRampToValueAtTime(0, now + durataFade);
      nota.osc.stop(now + durataFade);

      delete noteAttive[tasto];
      setTimeout(aggiornaMasterGain, durataFade * 1000);
    }

    document.addEventListener("keydown", (e) => {
      if (frequenze[e.key]) {
        if (e.key === "Tab") e.preventDefault();
        suonaNota(e.key);
      }
    });

    document.addEventListener("keyup", (e) => {
      interrompiNota(e.key);
    });

    document.body.addEventListener("click", inizializzaAudio);

    // Costruzione della tastiera
    const keyboardElement = document.getElementById('keyboard');

    // Posizioni dei tasti bianchi
    const whiteKeyPositions = [
      60, 116, 172, 228, 284, 340, 396, 452, 508, 564, 620, 676
    ];

    whiteKeys.forEach((key, index) => {
      const whiteKey = document.createElement('div');
      whiteKey.classList.add('white-key');
      whiteKey.style.left = `${whiteKeyPositions[index]}px`;

      const keyLabel = document.createElement('div');
      keyLabel.classList.add('key-label');
      keyLabel.innerText = noteLabels[index];
      whiteKey.appendChild(keyLabel);
      
      keyboardElement.appendChild(whiteKey);
    });

    // Posizioni dei tasti neri
    const blackKeyPositions = [
      90, 146, 202, 258, 314, 370, 426, 482, 538, 594, 650
    ];

    blackKeys.forEach((key, index) => {
      const blackKey = document.createElement('div');
      blackKey.classList.add('black-key');
      blackKey.style.left = `${blackKeyPositions[index]}px`;

      const keyLabel = document.createElement('div');
      keyLabel.classList.add('key-label');
      keyLabel.innerText = blackNoteLabels[index];
      blackKey.appendChild(keyLabel);
      
      keyboardElement.appendChild(blackKey);
    });
  </script>
</body>
</html>
