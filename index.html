<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suoni con la tastiera</title>
  <style>
    /* Stile per la tastiera */
    .tastiera {
      display: flex;
      justify-content: center;
      margin-top: 30px;
    }

    .tasto {
      width: 40px;
      height: 150px;
      background-color: white;
      border: 1px solid black;
      margin: 0 2px;
      position: relative;
      transition: background-color 0.2s;
    }

    .tasto.nero {
      width: 30px;
      height: 100px;
      background-color: black;
      position: absolute;
      top: 0;
      left: 30px;
      z-index: 1;
      margin-left: -15px;
      margin-right: -15px;
    }

    .tasto:active,
    .tasto.illuminato {
      background-color: yellow;
    }

    /* Stile per la disposizione della tastiera */
    .tasti-bianchi {
      display: flex;
      align-items: center;
    }

    .tasti-neri {
      display: flex;
      position: absolute;
      margin-left: 40px;
      margin-top: -100px;
      justify-content: space-between;
      width: 480px;
    }

    .tasti-neri .tasto {
      z-index: 2;
    }
  </style>
</head>
<body>
  <h1>Premi un tasto per ascoltare la nota</h1>
  <p>Note: Tab, Q, W, E, R, T, 1, 2, 3, 4, 5, 6, Y, U, I, O, P, [, 7, 8, 9, 0, ', ì</p>

  <div class="tastiera">
    <div class="tasti-bianchi">
      <div class="tasto" id="tab"></div>
      <div class="tasto" id="q"></div>
      <div class="tasto" id="w"></div>
      <div class="tasto" id="e"></div>
      <div class="tasto" id="r"></div>
      <div class="tasto" id="t"></div>
      <div class="tasto" id="1"></div>
      <div class="tasto" id="2"></div>
      <div class="tasto" id="3"></div>
      <div class="tasto" id="4"></div>
      <div class="tasto" id="5"></div>
      <div class="tasto" id="6"></div>
      <div class="tasto" id="y"></div>
      <div class="tasto" id="u"></div>
      <div class="tasto" id="i"></div>
      <div class="tasto" id="o"></div>
      <div class="tasto" id="p"></div>
      <div class="tasto" id="["></div>
      <div class="tasto" id="7"></div>
      <div class="tasto" id="8"></div>
      <div class="tasto" id="9"></div>
      <div class="tasto" id="0"></div>
      <div class="tasto" id="'"></div>
      <div class="tasto" id="ì"></div>
    </div>
    <div class="tasti-neri">
      <div class="tasto nero" id="q-#"></div>
      <div class="tasto nero" id="w-#"></div>
      <div class="tasto nero" id="r-#"></div>
      <div class="tasto nero" id="t-#"></div>
      <div class="tasto nero" id="2-#"></div>
      <div class="tasto nero" id="3-#"></div>
      <div class="tasto nero" id="5-#"></div>
      <div class="tasto nero" id="6-#"></div>
      <div class="tasto nero" id="7-#"></div>
      <div class="tasto nero" id="8-#"></div>
      <div class="tasto nero" id="9-#"></div>
    </div>
  </div>

  <script>
    const frequenze = {
      "Tab": 261.63,  "Q": 293.66,  "W": 329.63,  "E": 370.00,  "R": 415.30,  "T": 466.16,
      "1": 277.18,  "2": 311.13,  "3": 349.23,  "4": 392.00,  "5": 440.00,  "6": 493.88,
      "Y": 523.25, "U": 587.33, "I": 659.26, "O": 740.00, "P": 830.61, "[": 932.33,
      "7": 554.37, "8": 622.25, "9": 698.46, "0": 784.00, "'": 880.00, "ì": 987.77
    };

    let audioContext;
    let masterGain;
    const noteAttive = {};

    function inizializzaAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = audioContext.createGain();
        masterGain.gain.value = 1;
        masterGain.connect(audioContext.destination);
      }
    }

    function aggiornaMasterGain() {
      const attive = Object.keys(noteAttive).length;
      const volumeTotale = attive > 0 ? 1 / attive : 1;
      masterGain.gain.setValueAtTime(volumeTotale, audioContext.currentTime);
    }

    function suonaNota(tasto) {
      if (!frequenze[tasto]) return;
      inizializzaAudio();

      // Se già attiva, ignora
      if (noteAttive[tasto]) return;

      // Calcola nuovo gain prima di aggiungere la nota
      const nAttive = Object.keys(noteAttive).length;
      const nuovoVolume = 1 / (nAttive + 1);
      masterGain.gain.setValueAtTime(nuovoVolume, audioContext.currentTime);

      const osc = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      osc.frequency.setValueAtTime(frequenze[tasto], audioContext.currentTime);
      osc.type = 'sine';

      // Nessun fade-in: volume subito attivo
      gainNode.gain.setValueAtTime(1, audioContext.currentTime);

      osc.connect(gainNode).connect(masterGain);
      osc.start();

      noteAttive[tasto] = { osc, gainNode };

      aggiornaMasterGain();

      // Aggiungi illuminazione tasto
      illuminaTasto(tasto);
    }

    function interrompiNota(tasto) {
      const nota = noteAttive[tasto];
      if (!nota) return;

      const now = audioContext.currentTime;
      const durataFade = 0.5;

      nota.gainNode.gain.setValueAtTime(1, now);
      nota.gainNode.gain.linearRampToValueAtTime(0, now + durataFade);
      nota.osc.stop(now + durataFade);

      delete noteAttive[tasto];
      setTimeout(aggiornaMasterGain, durataFade * 1000);

      // Rimuovi illuminazione tasto
      spegniTasto(tasto);
    }

    function illuminaTasto(tasto) {
      const tastoElement = document.getElementById(tasto);
      if (tastoElement) {
        tastoElement.classList.add('illuminato');
      }
    }

    function spegniTasto(tasto) {
      const tastoElement = document.getElementById(tasto);
      if (tastoElement) {
        tastoElement.classList.remove('illuminato');
      }
    }

    document.addEventListener("keydown", (e) => {
      if (frequenze[e.key]) {
        if (e.key === "Tab") e.preventDefault();
        suonaNota(e.key);
      }
    });

    document.addEventListener("keyup", (e) => {
      interrompiNota(e.key);
    });

    document.body.addEventListener("click", inizializzaAudio);
  </script>
</body>
</html>
