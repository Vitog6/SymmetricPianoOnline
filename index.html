<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suoni con la tastiera</title>
  <style>
    body {
      background-color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding-bottom: 100px; /* Aggiunge spazio sotto la pagina per evitare che le tastiere siano troppo in basso */
    }
    .intro {
      color: white;
      padding: 20px;
      max-width: 900px;
      text-align: center;
      margin-bottom: 30px;
    }
    .keyboard {
      position: relative;
      width: 780px;
      height: 200px;
      transform: rotate(180deg);
      margin-bottom: 50px;
    }
    .white-key, .black-key {
      position: absolute;
      bottom: 0;
      border: 1px solid #000;
      cursor: pointer;
      box-sizing: border-box;
      user-select: none;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      padding-bottom: 5px;
      font-family: sans-serif;
      font-size: 12px;
    }
    .white-key {
      width: 60px;
      height: 200px;
      background: white;
      z-index: 1;
    }
    .black-key {
      width: 40px;
      height: 120px;
      background: black;
      color: white;
      z-index: 2;
    }
    .white-key.active {
      background: #ccc;
    }
    .black-key.active {
      background: #444;
    }
    .key-name {
      position: absolute;
      top: 5px;
      width: 100%;
      text-align: center;
      transform: rotate(180deg);
    }
</style>
</head>
<body>
  <div class="intro">
    <h1>Benvenuti alla tastiera musicale sperimentale</h1>
    <p>Questa è una tastiera musicale che emula le note di un pianoforte tradizionale, ma con una disposizione dei tasti completamente diversa. Ogni tasto corrisponde a una delle 12 note della scala musicale, e le note sono assegnate ai tasti come segue:</p>
    <ul>
      <p> La prima scala ha i tasti bainchi dallo "Shift" alla "è" e i neri dall "1" al "ì". la seconda scala ha i tasti bianchi da "<" e i neri dalla "a" alla "ù".</p>
    <p> INSERIRE IL BLOCCO MAIUSCOLO PER SUONARE. Questa tastiera è un progetto sperimentale che esplora una nuova disposizione dei tasti. Sebbene le note siano le stesse di un piano tradizionale, l'organizzazione dei tasti è completamente differente. In questo nuovo tipo di pianoforte, tutte le dodici note sono suddivise in toni e semitoni, con sei tasti neri e sei bianchi.</p>
    <p>In questa tastiera, i tasti bianchi sono separati da un tono di distanza l'uno dall'altro, così come i tasti neri. Questa struttura consente di riprodurre qualsiasi brano musicale spostandosi tra i tasti in modo più fluido, permettendo di suonare gli stessi brani ma spostandosi di qualsivoglia numero di semitoni.</p>
    <p>Questo è un esperimento per esplorare un nuovo tipo di pianoforte che potrebbe un giorno aprire la strada a modi più versatili e creativi di eseguire la musica. Spero che tu possa apprezzare la magnifica regolarità e simmatricità delle dodici note che sono, a mio parere, mal rapresentate dall' attuale disposizione dei tasti nei pianoforti comuni.</p>
    <p> Il suono non è dei migliori lo so, ma il mio obbiettivo era mettere in pratica questa mia idea, spero possa esseere apprezzata. Grazie </p>
  </div>
  <div class="keyboard" id="keyboard"></div>
  <div class="keyboard" id="keyboard2"></div>
  <script>
    const frequenze = {
      "Tab": 130.81,  "Q": 146.83,  "W": 164.82,  "E": 185.00,  "R": 207.65,  "T": 233.08,
      "1": 138.59,  "2": 155.57,  "3": 174.62,  "4": 196.00,  "5": 220.00,  "6": 246.94,
      "Y": 261.63, "U": 293.66, "I": 329.63, "O": 370.00, "P": 415.30, "è": 466.16,
      "7": 277.18, "8": 311.13, "9": 349.23, "0": 392.00, "'": 440.00, "ì": 493.88, "<": 523.24,  
      "Z": 587.32,  "X": 659.28,  "C": 740.00,  "V": 830.60,  "B": 932.32,
      "A": 554.36,  "S": 622.28,  "D": 698.48,  "F": 784.00,  "G": 880.00,  "H": 987.76,
      "N": 1046.52, "M": 1174.64, ",": 1318.52, ".": 1480.00, "-": 1661.20, "Shift": 1864.64,
      "J": 1108.72, "K": 1244.52, "L": 1396.92, "ò": 1568.00, "à": 1760.00, "ù": 1975.52
    };

    const keyboard = document.getElementById("keyboard");
    const keyboard2 = document.getElementById("keyboard2");

    const noteBianche = ["Do", "Re", "Mi", "Fa#", "Sol#", "La#", "Do", "Re", "Mi", "Fa#", "Sol#", "La#"].reverse();
    const noteNere = ["Do#", "Re#", "Fa", "Sol", "La", "Si", "Do#", "Re#", "Fa", "Sol", "La", "Si"].reverse();

    const tastiBianchi = ["Tab", "Q", "W", "E", "R", "T", "Y", "U", "I", "O", "P", "è"].reverse();
    const tastiNeri = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "'", "ì"].reverse();

    tastiBianchi.forEach((key, i) => {
      const el = document.createElement("div");
      el.className = "white-key";
      el.style.left = `${60 * (i + 1)}px`;
      el.dataset.key = key;
      el.innerHTML = `<div class="key-name">${noteBianche[i]}</div>`;
      keyboard.appendChild(el);
    });

    const offsetNeri = [40, 100, 160, 220, 280, 340, 400, 460, 520, 580, 640, 700];
    tastiNeri.forEach((key, i) => {
      const el = document.createElement("div");
      el.className = "black-key";
      el.style.left = `${offsetNeri[i]}px`;
      el.dataset.key = key;
      el.innerHTML = `<div class="key-name">${noteNere[i]}</div>`;
      keyboard.appendChild(el);
    });

    const tastiBianchi2 = ["<", "Z", "X", "C", "V", "B", "N", "M", ",", ".", "-", "Shift"].reverse();
    const noteBianche2 = noteBianche;
    const tastiNeri2 = ["A", "S", "D", "F", "G", "H", "J", "K", "L", "ò", "à", "ù"].reverse();
    const noteNere2 = noteNere;

    tastiBianchi2.forEach((key, i) => {
      const el = document.createElement("div");
      el.className = "white-key";
      el.style.left = `${60 * (i + 1)}px`;
      el.dataset.key = key;
      el.innerHTML = `<div class="key-name">${noteBianche2[i]}</div>`;
      keyboard2.appendChild(el);
    });

    tastiNeri2.forEach((key, i) => {
      const el = document.createElement("div");
      el.className = "black-key";
      el.style.left = `${offsetNeri[i]}px`;
      el.dataset.key = key;
      el.innerHTML = `<div class="key-name">${noteNere2[i]}</div>`;
      keyboard2.appendChild(el);
    });

    let audioContext;
    let masterGain;
    let limiter;
    const noteAttive = {};

    function inizializzaAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        limiter = audioContext.createDynamicsCompressor();
        limiter.threshold.setValueAtTime(-1, audioContext.currentTime);
        limiter.knee.setValueAtTime(0, audioContext.currentTime);
        limiter.ratio.setValueAtTime(20, audioContext.currentTime);
        limiter.attack.setValueAtTime(0.001, audioContext.currentTime);
        limiter.release.setValueAtTime(0.05, audioContext.currentTime);
        masterGain = audioContext.createGain();
        masterGain.gain.value = 1;
        masterGain.connect(limiter);
        limiter.connect(audioContext.destination);
      }
    }

    function aggiornaMasterGain() {
      const attive = Object.keys(noteAttive).length;
      const volumeTotale = attive > 0 ? 1 / attive : 1;
      masterGain.gain.setValueAtTime(volumeTotale, audioContext.currentTime);
    }

    function suonaNota(tasto) {
      if (!frequenze[tasto]) return;
      inizializzaAudio();
      if (noteAttive[tasto]) return;
      const osc = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      osc.frequency.setValueAtTime(frequenze[tasto], audioContext.currentTime);
      osc.type = 'sine';
      gainNode.gain.setValueAtTime(1, audioContext.currentTime);
      osc.connect(gainNode).connect(masterGain);
      osc.start();
      noteAttive[tasto] = { osc, gainNode };
      const el = document.querySelector(`[data-key="${tasto}"]`);
      if (el) el.classList.add("active");
      aggiornaMasterGain();
    }

    function interrompiNota(tasto) {
      const nota = noteAttive[tasto];
      if (!nota) return;
      const now = audioContext.currentTime;
      const durataFade = 0.5;
      nota.gainNode.gain.setValueAtTime(1, now);
      nota.gainNode.gain.linearRampToValueAtTime(0, now + durataFade);
      nota.osc.stop(now + durataFade);
      delete noteAttive[tasto];
      const el = document.querySelector(`[data-key="${tasto}"]`);
      if (el) el.classList.remove("active");
      setTimeout(aggiornaMasterGain, durataFade * 1000);
    }

    document.addEventListener("keydown", (e) => {
      if (frequenze[e.key]) {
        if (e.key === "Tab") e.preventDefault();
        suonaNota(e.key);
      }
    });

    document.addEventListener("keyup", (e) => {
      interrompiNota(e.key);
    });

    document.querySelectorAll('.white-key, .black-key').forEach(el => {
      el.addEventListener("mousedown", () => suonaNota(el.dataset.key));
      el.addEventListener("mouseup", () => interrompiNota(el.dataset.key));
      el.addEventListener("mouseleave", () => interrompiNota(el.dataset.key));
    });

    document.body.addEventListener("click", inizializzaAudio);
  </script>
</body>
</html>
