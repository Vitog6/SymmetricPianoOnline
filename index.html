<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tastiera musicale avanzata</title>
</head>
<body>
  <h1>Premi un tasto per ascoltare la nota</h1>
  <p>Note: Tab, Q, W, E, R, T, 1, 2, 3, 4, 5, 6, Y, U, I, O, P, [, 7, 8, 9, 0, ', ì</p>

  <script>
    const frequenze = {
      "Tab": 261.63,  "Q": 293.66,  "W": 329.63,  "E": 370.00,  "R": 415.30,  "T": 466.16,
      "1": 277.18,  "2": 311.13,  "3": 349.23,  "4": 392.00,  "5": 440.00,  "6": 493.88,
      "Y": 523.25, "U": 587.33, "I": 659.26, "O": 740.00, "P": 830.61, "[": 932.33,
      "7": 554.37, "8": 622.25, "9": 698.46, "0": 784.00, "'": 880.00, "ì": 987.77
    };

    let audioContext;
    let masterGain;
    const noteAttive = new Map(); // tasto -> { osc, gainNode, gain }

    function inizializzaAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = audioContext.createGain();
        masterGain.gain.value = 1;
        masterGain.connect(audioContext.destination);

        requestAnimationFrame(aggiornaBilanciamento);
      }
    }

    function aggiornaBilanciamento() {
      let somma = 0;
      const now = audioContext.currentTime;

      for (const nota of noteAttive.values()) {
        try {
          somma += nota.gainNode.gain.value;
        } catch {}
      }

      masterGain.gain.setValueAtTime(somma > 0 ? 1 / somma : 1, now);
      requestAnimationFrame(aggiornaBilanciamento);
    }

    function suonaNota(tasto) {
      if (!frequenze[tasto] || noteAttive.has(tasto)) return;
      inizializzaAudio();

      const osc = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      const now = audioContext.currentTime;

      osc.type = 'sine';
      osc.frequency.setValueAtTime(frequenze[tasto], now);

      gainNode.gain.setValueAtTime(1, now); // volume pieno
      osc.connect(gainNode).connect(masterGain);
      osc.start();

      noteAttive.set(tasto, { osc, gainNode });
    }

    function interrompiNota(tasto) {
      const nota = noteAttive.get(tasto);
      if (!nota) return;

      const now = audioContext.currentTime;
      const durata = 1.0; // fade-out in secondi

      nota.gainNode.gain.cancelScheduledValues(now);
      nota.gainNode.gain.setValueAtTime(nota.gainNode.gain.value, now);
      nota.gainNode.gain.linearRampToValueAtTime(0, now + durata);

      nota.osc.stop(now + durata + 0.05);

      setTimeout(() => {
        noteAttive.delete(tasto);
      }, (durata + 0.1) * 1000);
    }

    document.addEventListener("keydown", e => {
      if (frequenze[e.key]) {
        if (e.key === "Tab") e.preventDefault();
        suonaNota(e.key);
      }
    });

    document.addEventListener("keyup", e => {
      interrompiNota(e.key);
    });

    document.body.addEventListener("click", inizializzaAudio);
  </script>
</body>
</html>
