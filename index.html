<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pianoforte Dinamico</title>
</head>
<body>
  <h1>Premi un tasto per ascoltare la nota</h1>
  <p>Usa la tastiera per suonare. Due pressioni ravvicinate dello stesso tasto aumentano il volume percepito.</p>

  <script>
    const frequenze = {
      "Tab": 261.63, "Q": 293.66, "W": 329.63, "E": 370.00, "R": 415.30, "T": 466.16,
      "1": 277.18, "2": 311.13, "3": 349.23, "4": 392.00, "5": 440.00, "6": 493.88,
      "Y": 261.63 * 2, "U": 293.66 * 2, "I": 329.63 * 2, "O": 370.00 * 2, "P": 415.30 * 2, "[": 466.16 * 2,
      "7": 277.18 * 2, "8": 311.13 * 2, "9": 349.23 * 2, "0": 392.00 * 2, "'": 440.00 * 2, "Ã¬": 493.88 * 2
    };

    let audioContext;
    let mixGain;
    const noteAttive = new Map(); // tasto -> array di istanze { osc, gain, fadeOut }

    function inizializzaAudioContext() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        mixGain = audioContext.createGain();
        mixGain.gain.value = 1;
        mixGain.connect(audioContext.destination);
      }
    }

    function aggiornaVolumi() {
      // Calcola tutte le istanze ancora attive (comprese quelle in fade-out)
      const tutteLeNote = Array.from(noteAttive.values()).flat();
      const attive = tutteLeNote.filter(n => !n.fadeOut);
      const fadeOuts = tutteLeNote.filter(n => n.fadeOut);

      const totale = attive.length + fadeOuts.length;
      if (totale === 0) return;

      attive.forEach(n => {
        n.gain.gain.setTargetAtTime(1 / totale, audioContext.currentTime, 0.01);
      });
    }

    function suonaNota(tasto) {
      if (!frequenze[tasto]) return;
      inizializzaAudioContext();

      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      const freq = frequenze[tasto];

      osc.type = "sine";
      osc.frequency.setValueAtTime(freq, audioContext.currentTime);
      gain.gain.setValueAtTime(1, audioContext.currentTime);

      osc.connect(gain).connect(mixGain);
      osc.start();

      const istanza = { osc, gain, fadeOut: false };

      if (!noteAttive.has(tasto)) noteAttive.set(tasto, []);
      noteAttive.get(tasto).push(istanza);

      aggiornaVolumi();
    }

    function interrompiNota(tasto) {
      const istanze = noteAttive.get(tasto);
      if (!istanze) return;

      const now = audioContext.currentTime;
      const fadeDuration = 0.3;

      istanze.forEach((n, i) => {
        if (n.fadeOut) return;
        n.fadeOut = true;
        n.gain.gain.cancelScheduledValues(now);
        n.gain.gain.setValueAtTime(n.gain.gain.value, now);
        n.gain.gain.exponentialRampToValueAtTime(0.0001, now + fadeDuration);
        n.osc.stop(now + fadeDuration + 0.05);
        setTimeout(() => {
          const arr = noteAttive.get(tasto);
          if (arr) {
            arr.splice(arr.indexOf(n), 1);
            if (arr.length === 0) noteAttive.delete(tasto);
            aggiornaVolumi();
          }
        }, (fadeDuration + 0.1) * 1000);
      });
    }

    document.addEventListener("keydown", function(event) {
      const tasto = event.key;
      if (frequenze[tasto]) {
        if (tasto === "Tab") event.preventDefault(); // evita cambio focus
        suonaNota(tasto);
      }
    });

    document.addEventListener("keyup", function(event) {
      interrompiNota(event.key);
    });

    document.body.addEventListener("click", inizializzaAudioContext);
  </script>
</body>
</html>
